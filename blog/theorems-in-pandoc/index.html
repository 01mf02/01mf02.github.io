<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Theorems in Pandoc - gedenkt.at</title>

    <link rel="icon" type="image/png" href="../../media/gedenkt_small.png">
    <link rel="stylesheet" type="text/css" href="../../css/default.css">
    <link rel="stylesheet" type="text/css" href="../../css/syntax.css">
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../../"><img src="../../media/gedenkt_small.png" /></a>
      </div>
      <div id="navigation">
        <a href="../../">Initium</a>
        <a href="../../erasmus.html">Erasmus</a>
        <a href="../../musica.html">Musica</a>
        <a href="../../blog.html">Blog</a>
      </div>
    </div>

    <div id="content">
      <h1>Theorems in Pandoc</h1>

      <img src="../../media/gedenkt.png" style="float: right; margin: 10px;" />

<div class="info">
    Geschrieben am 06. Juni 2016
    
</div>

<p>When writing mathematical Markdown documents, definitions, lemmas and proofs can add considerably noise to the document. For example:</p>
<div class="sourceCode"><pre class="sourceCode latex"><code class="sourceCode latex">\begin{definition}[Iteration]
The iteration of a function is $\iterate(f, x) = f(x) \cup \iterate(f, f(x)).$
\end{definition}</code></pre></div>
<p>Wouldn’t it be nicer to write the following?</p>
<pre><code>Definition (Iteration).
The iteration of a function is $\iterate(f, x) = f(x) \cup \iterate(f, f(x)).$</code></pre>
<p>I had enough of scratching this itch, so I bandaged it with a nice Pandoc filter that allows to you write stuff like above and render it correctly with LaTeX. For example, you can write the following:</p>
<pre><code>This is a little example of how to use naturally-looking
mathematical environments in Pandoc.

Definition (Natural numbers). \label{def:nat}
Let $\mathbb{N}$ the set ${0, 1, 2, \ldots}$

We now use definition \ref{def:nat} to show a simple property.

Lemma. $\mathbb{N}$ is infinite.

Proof. Trivial.

This leads us to our main result.

Theorem (Greatest element). There does not exist a greatest element in $\mathbb{N}$.

Proof (Proof of the main theorem). Also trivial.</code></pre>
<p>To use it, we first create a file where we put our environment definitions. Call it “envs.tex”, for example:</p>
<div class="sourceCode"><pre class="sourceCode latex"><code class="sourceCode latex">\usepackage{amsthm}

\newtheorem{definition}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}</code></pre></div>
<p>Now, get ready for the main Pandoc filter. Save it under “environmentalize.hs” and make it executable.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="st">#!/usr/bin/env runghc</span>
<span class="kw">import </span><span class="dt">Data.List</span> (stripPrefix)
<span class="kw">import </span><span class="dt">Data.Maybe</span> (isJust, fromJust, fromMaybe)
<span class="kw">import </span><span class="dt">Text.Pandoc.JSON</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> toJSONFilter replaceEnvs

<span class="co">-- | See stripPrefix.</span>
<span class="ot">stripPostfix ::</span> <span class="dt">Eq</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [a]
stripPostfix post l <span class="fu">=</span> reverse <span class="fu">&lt;$&gt;</span> stripPrefix (reverse post) (reverse l)

<span class="ot">fromStr ::</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span>
fromStr (<span class="dt">Str</span> s) <span class="fu">=</span> <span class="dt">Just</span> s
fromStr _ <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">stripStrPostfix ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Inline</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span>
stripStrPostfix post inline <span class="fu">=</span> fromStr inline <span class="fu">&gt;&gt;=</span> stripPostfix post

<span class="co">-- | If the list of Inlines starts with a Str that starts with the prefix</span>
<span class="co">-- and the list contains a Str that ends with the postfix, then</span>
<span class="co">-- return everything between prefix and postfix, as well as everything after.</span>
<span class="fu">--</span>
<span class="co">-- Example:</span>
<span class="co">--     inlineBetween &quot;(&quot; &quot;)&quot; [Str &quot;(What&quot;, Space, Str &quot;else?)&quot;, Str &quot;Text&quot;] =</span>
<span class="co">--     Just ([Str &quot;What&quot;, Space, Str &quot;else?&quot;], [Str &quot;Text&quot;])</span>
<span class="ot">inlineBetween ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> ([<span class="dt">Inline</span>], [<span class="dt">Inline</span>])
inlineBetween pre post (<span class="dt">Str</span> s <span class="fu">:</span> xs) <span class="fu">|</span> <span class="dt">Just</span> s' <span class="ot">&lt;-</span> stripPrefix pre s <span class="fu">=</span>
  <span class="kw">case</span> break (isJust <span class="fu">.</span> stripStrPostfix post) (<span class="dt">Str</span> s' <span class="fu">:</span> xs) <span class="kw">of</span>
    (_, []) <span class="ot">-&gt;</span> <span class="dt">Nothing</span>
    (x, y<span class="fu">:</span>ys) <span class="ot">-&gt;</span> <span class="dt">Just</span> (x <span class="fu">++</span> [<span class="dt">Str</span> <span class="fu">$</span> fromJust <span class="fu">$</span> stripStrPostfix post y], ys)
inlineBetween _ _ _ <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">envs ::</span> [(<span class="dt">String</span>, <span class="dt">String</span>)]
envs <span class="fu">=</span>
  [ (<span class="st">&quot;Definition&quot;</span>, <span class="st">&quot;definition&quot;</span>)
  , (<span class="st">&quot;Lemma&quot;</span>, <span class="st">&quot;lemma&quot;</span>)
  , (<span class="st">&quot;Theorem&quot;</span>, <span class="st">&quot;theorem&quot;</span>)
  , (<span class="st">&quot;Proof&quot;</span>, <span class="st">&quot;proof&quot;</span>)
  ]

<span class="co">-- | Try all different environment types.</span>
<span class="ot">replaceEnvs ::</span> <span class="dt">Maybe</span> <span class="dt">Format</span> <span class="ot">-&gt;</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span>
replaceEnvs fmt blk <span class="fu">=</span> foldr (<span class="fu">$</span>) blk (map (replaceEnv fmt) envs)

<span class="ot">makeEnv ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> [<span class="dt">Inline</span>]
makeEnv env name label text <span class="fu">=</span>
  maybe ([tex begin]) (\ n <span class="ot">-&gt;</span> [tex <span class="fu">$</span> begin <span class="fu">++</span> <span class="st">&quot;[&quot;</span>] <span class="fu">++</span> n <span class="fu">++</span> [tex <span class="st">&quot;]&quot;</span>]) name <span class="fu">++</span>
  maybe [] (\ l <span class="ot">-&gt;</span> [tex <span class="fu">$</span> <span class="st">&quot;\\label{&quot;</span> <span class="fu">++</span> l <span class="fu">++</span> <span class="st">&quot;}&quot;</span>]) label <span class="fu">++</span>
  text <span class="fu">++</span> [tex end]
  <span class="kw">where</span>
    tex <span class="fu">=</span> <span class="dt">RawInline</span> (<span class="dt">Format</span> <span class="st">&quot;latex&quot;</span>)
    begin <span class="fu">=</span> <span class="st">&quot;\\begin{&quot;</span> <span class="fu">++</span> env <span class="fu">++</span> <span class="st">&quot;}&quot;</span>
    end   <span class="fu">=</span> <span class="st">&quot;\\end{&quot;</span>   <span class="fu">++</span> env <span class="fu">++</span> <span class="st">&quot;}&quot;</span>

<span class="co">-- | Try to read name and create environment.</span>
<span class="ot">nameEnv ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Block</span>
nameEnv env label ys <span class="fu">=</span> paraEnv <span class="fu">&lt;$&gt;</span> inlineBetween <span class="st">&quot;(&quot;</span> <span class="st">&quot;).&quot;</span> ys
  <span class="kw">where</span> paraEnv (name, rest) <span class="fu">=</span> <span class="dt">Para</span> <span class="fu">$</span> makeEnv env (<span class="dt">Just</span> name) label rest

<span class="co">-- | Try to read label and name, and create environment.</span>
<span class="ot">labelNameEnv ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Inline</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Block</span>
labelNameEnv env ys <span class="fu">=</span> <span class="kw">case</span> ys <span class="kw">of</span>
  <span class="co">-- Example: Theorem pyth.</span>
  <span class="dt">Str</span> (l<span class="fu">:</span>bld) <span class="fu">:</span> zs <span class="fu">|</span> l <span class="fu">/=</span> <span class="ch">'('</span>, <span class="dt">Just</span> bl <span class="ot">&lt;-</span> stripPostfix <span class="st">&quot;.&quot;</span> bld <span class="ot">-&gt;</span>
    <span class="dt">Just</span> <span class="fu">$</span> <span class="dt">Para</span> <span class="fu">$</span> makeEnv env <span class="dt">Nothing</span> (<span class="dt">Just</span> (l<span class="fu">:</span>bl)) zs
  <span class="co">-- Example: Theorem pyth (Pythagoras).</span>
  <span class="dt">Str</span> (l<span class="fu">:</span>bl) <span class="fu">:</span> <span class="dt">Space</span> <span class="fu">:</span> zs <span class="fu">|</span> l <span class="fu">/=</span> <span class="ch">'('</span> <span class="ot">-&gt;</span> nameEnv env (<span class="dt">Just</span> (l<span class="fu">:</span>bl)) zs
  <span class="co">-- Example: Theorem (Pythagoras).</span>
  _ <span class="ot">-&gt;</span> nameEnv env <span class="dt">Nothing</span> ys
  

<span class="ot">replaceEnv ::</span> <span class="dt">Maybe</span> <span class="dt">Format</span> <span class="ot">-&gt;</span> (<span class="dt">String</span>, <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">Block</span> <span class="ot">-&gt;</span> <span class="dt">Block</span>
replaceEnv (<span class="dt">Just</span> (<span class="dt">Format</span> <span class="st">&quot;latex&quot;</span>)) (txt, latex) p<span class="fu">@</span>(<span class="dt">Para</span> (<span class="dt">Str</span> x <span class="fu">:</span> xs)) <span class="fu">=</span>
  <span class="kw">if</span> x <span class="fu">==</span> txt <span class="fu">++</span> <span class="st">&quot;.&quot;</span> <span class="kw">then</span> <span class="dt">Para</span> <span class="fu">$</span> makeEnv latex <span class="dt">Nothing</span> <span class="dt">Nothing</span> xs
  <span class="kw">else</span> <span class="kw">if</span> x <span class="fu">==</span> txt <span class="kw">then</span> <span class="kw">case</span> xs <span class="kw">of</span>
    (<span class="dt">Space</span> <span class="fu">:</span> ys) <span class="ot">-&gt;</span> fromMaybe p (labelNameEnv latex ys)
    _ <span class="ot">-&gt;</span> p
  <span class="kw">else</span> p
replaceEnv _ _ x <span class="fu">=</span> x</code></pre></div>
<p>Now, you can run Pandoc with the filter as follows (<code>-H</code> includes something at the end of the <em>h</em>eader):</p>
<pre><code>pandoc --filter ./environmentalize.hs test.md -H envs.tex -o test.pdf</code></pre>
<p>Have fun with mathematical environments in Pandoc! :)</p>
<p>P.S.: It is currently quite cumbersome to “parse” the <code>Inline</code> lists of Pandoc. Something like Parsec for Pandoc would be definitely cool, and problems like this one could probably be solved much more elegantly than with my ad-hoc low-level parsing functions.</p>

    </div>

    <div id="footer">
      Post: (λ name domain. name@domain) "michael.faerber" "gedenkt.at"
    </div>
  </body>
</html>

<script async type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
