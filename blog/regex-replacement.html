<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Replacing regular expressions - gedenkt.at</title>

    <link rel="icon" type="image/png" href="../media/gedenkt_small.png">
    <link rel="stylesheet" type="text/css" href="../css/default.css">
    <link rel="stylesheet" type="text/css" href="../css/syntax.css">
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../"><img src="../media/gedenkt_small.png" /></a>
      </div>
      <div id="navigation">
        <a href="../">Initium</a>
        <a href="../erasmus.html">Erasmus</a>
        <a href="../musica.html">Musica</a>
        <a href="../blog.html">Blog</a>
      </div>
    </div>

    <div id="content">
      <h1>Replacing regular expressions</h1>

      <img src="../media/gedenkt.png" style="float: right; margin: 10px;" />

<div class="info">
    Geschrieben am 20. Jänner 2015
    
</div>

<p>I present a problem which I wanted to solve with regular expressions, but for which a <code>sed</code> solution would be complicated. Consequentially, I show how to solve the problem with Haskell.</p>
<h2 id="problem">Problem</h2>
<p>For displaying images with captions on my website, so far I used HTML code as the following:</p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;img-container&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">&quot;/media/Arcachon.jpg&quot;</span> <span class="kw">/&gt;</span>
  <span class="kw">&lt;p&gt;</span>Les Dunes.<span class="kw">&lt;/p&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre>
<p>I wanted to replace this with Markdown syntax, which looks as follows:</p>
<pre><code>![Les Dunes.](/media/Arcachon.jpg)</code></pre>
<p>Much less to type that way. :) However, in my existing files, I used the img-container about 50 times, which was clearly too much for me to replace by hand. Therefore, I first considered giving my good old friend <code>sed</code> a spin to automatise the replacement. Unfortunately, I quickly found out via <a href="http://unix.stackexchange.com/questions/26284/how-can-i-use-sed-to-replace-a-multi-line-string">Stack Overflow</a> that <code>sed</code> seems to work best if you process files line by line, and in my case, I had to match a pattern over multiple lines. For about one minute, I considered the advice in the Stack Overflow post to use Perl for the task, but as I do not know how to program in Perl and did not want to learn it for this apparently simple task, I researched a Haskell solution to this problem, which turned out to be very nice.</p>
<h2 id="solution">Solution</h2>
<p>In Haskell’s <a href="https://hackage.haskell.org/package/regex-compat/docs/Text-Regex.html">Text.Regex</a> module, you have a function called <code>subRegex</code>, which takes an input string and replaces all matches of a regular expression by a replacement string. After some fiddling, I came up with the following:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Text.Regex</span>

regex <span class="fu">=</span> unlines
  [ <span class="st">&quot;&lt;div class=\&quot;img-container\&quot;&gt;&quot;</span>
  , <span class="st">&quot;  &lt;img src=\&quot;(.*)\&quot; /&gt;&quot;</span> <span class="co">-- 1st capture group, filename</span>
  , <span class="st">&quot;  &lt;p&gt;(.*)&lt;/p&gt;&quot;</span>          <span class="co">-- 2nd capture group, description</span>
  , <span class="st">&quot;&lt;/div&gt;&quot;</span>
  ]

testText <span class="fu">=</span> unlines
  [ <span class="st">&quot;&lt;div class=\&quot;img-container\&quot;&gt;&quot;</span>
  , <span class="st">&quot;  &lt;img src=\&quot;/media/Arcachon.jpg\&quot; /&gt;&quot;</span>
  , <span class="st">&quot;  &lt;p&gt;Les Dunes.&lt;/p&gt;&quot;</span>
  , <span class="st">&quot;&lt;/div&gt;&quot;</span>
  ]

main <span class="fu">=</span> print <span class="fu">$</span> subRegex (mkRegex regex) testText <span class="st">&quot;![\\2](\\1)\n&quot;</span></code></pre>
<p>Let us try it:</p>
<pre><code>michi ~ $ runhaskell regex.hs
&quot;![Les Dunes.](/media/Arcachon.jpg)\n&quot;</code></pre>
<p>Yes, it works! (At this point, I confess that I took at least one hour to come up with this whole solution, including a countless number of “oh no, why does it not work?”.)</p>
<p>I tested this with some other examples, and on one example, nothing was replaced. It was the following:</p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;img-container&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">&quot;/media/2012-09-16-jai-besoin-dun-velo/Photo1473.jpg&quot;</span> <span class="kw">/&gt;</span>
  <span class="kw">&lt;p&gt;</span>Modèles de Calcul (während der Pause aufgenommen).<span class="kw">&lt;/p&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre>
<p>What is wrong about this? It contains ‘è’ and ‘ä’. “But we are in the 21th century, what about Unicode?”, I hear you blubber out in disbelief. I concur, but apparently old habits die hard, and Unicode is still not supported everywhere. Fear not, for you have a remedy at hand: The <a href="https://hackage.haskell.org/package/regex-compat/docs/Text-Regex.html">Text.Regex</a> module which I used is provided by several packages, the default one being <a href="https://hackage.haskell.org/package/regex-compat">regex-compat</a>, which does seem to not support Unicode. However, as I found out via <a href="http://stackoverflow.com/questions/2098314/haskells-text-regex-subregex-using-tdfa-implementation">Stack Overflow</a>, there is a replacement called <a href="https://hackage.haskell.org/package/regex-compat-tdfa">regex-compat-tdfa</a> which supports Unicode. One <code>cabal-install regex-compat-tdfa</code> later, I get a new error message:</p>
<pre><code>michi ~ $ ghci
GHCi, version 7.6.3: http://www.haskell.org/ghc/  :? for help
Prelude&gt; import Text.Regex

&lt;no location info&gt;:
    Ambiguous module name `Text.Regex':
      it was found in multiple packages:
      regex-compat-tdfa-0.95.1.4 regex-compat-0.95.1</code></pre>
<p>Sigh. I knew this was not going to be that easy. So I somehow have to remove the old regex-compat package. Luckily, it turned out that I had a package called libghc-regex-compat-dev on my Linux system, which I removed via my package manager. After that, I could load Text.Regex just fine, and it matched strings containing “strange” characters just as well. Great!</p>
<p>Now we are able to match simple test strings, but we want to search and replace within a whole file. How do we do that? Luckily, Haskell has an awesome function called <code>interact</code>, which reads from standard input, passes the input to a function, and writes the output of the function to standard output. The solution utilising <code>interact</code> is:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell">main <span class="fu">=</span> interact (\ f <span class="ot">-&gt;</span> subRegex (mkRegex regex) f <span class="st">&quot;![\\2](\\1)\n&quot;</span>)</code></pre>
<p>To use our program on an existing file, we have to <code>cat</code> the file to the Haskell script and pipe its output to a new file. To do this for multiple files, I used bash:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">mkdir</span> modified
<span class="kw">for</span> <span class="kw">i</span> in *.md<span class="kw">;</span> <span class="kw">do</span> <span class="kw">cat</span> <span class="ot">$</span>i <span class="kw">|</span> <span class="kw">runhaskell</span> regex.hs <span class="kw">&gt;</span> modified/<span class="ot">$</span>i<span class="kw">;</span> <span class="kw">done</span></code></pre>
<p>And that’s it! For your reference, here is the final Haskell file:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Text.Regex</span>

regex <span class="fu">=</span> unlines
  [ <span class="st">&quot;&lt;div class=\&quot;img-container\&quot;&gt;&quot;</span>
  , <span class="st">&quot;  &lt;img src=\&quot;(.*)\&quot; /&gt;&quot;</span> <span class="co">-- 1st capture group, filename</span>
  , <span class="st">&quot;  &lt;p&gt;(.*)&lt;/p&gt;&quot;</span>          <span class="co">-- 2nd capture group, description</span>
  , <span class="st">&quot;&lt;/div&gt;&quot;</span>
  ]

main <span class="fu">=</span> interact (\ f <span class="ot">-&gt;</span> subRegex (mkRegex regex) f <span class="st">&quot;![\\2](\\1)\n&quot;</span>)</code></pre>

    </div>

    <div id="footer">
      Post: (λ name domain. name@domain) "michael.faerber" "gedenkt.at"
    </div>
  </body>
</html>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
